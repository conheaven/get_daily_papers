<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>çˆ¬å–ç®¡ç† - Academic Paper Crawler</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
  </head>
  <body>
    <nav class="navbar">
      <div class="navbar-content">
        <a href="/" class="navbar-brand">
          <span>ğŸ“š</span>
          <span>Academic Papers</span>
        </a>
        <ul class="navbar-nav">
          <li><a href="/">æµè§ˆè®ºæ–‡</a></li>
          <li><a href="/crawl">çˆ¬å–ç®¡ç†</a></li>
          <li><a href="/statistics">ç»Ÿè®¡ä¿¡æ¯</a></li>
          <li><a href="/config">é…ç½®</a></li>
        </ul>
      </div>
    </nav>

    <div class="container">
      <div class="card fade-in">
        <h2 class="card-title">ğŸš€ å¿«é€Ÿçˆ¬å–</h2>
        <div class="filter-form" style="margin-bottom: 24px">
          <div class="form-group">
            <label class="form-label">é€‰æ‹©ä¼šè®®</label>
            <select id="conference">
              <option value="">è¯·é€‰æ‹©ä¼šè®®</option>
              {% for conf in conferences %} {% if conf.enabled %}
              <option value="{{ conf.name }}">
                {{ conf.name }} - {{ conf.description }}
              </option>
              {% endif %} {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">é€‰æ‹©å¹´ä»½</label>
            <input
              type="number"
              id="year"
              placeholder="ä¾‹å¦‚: 2024"
              min="2000"
              max="2030"
            />
          </div>
          <button class="btn btn-primary" onclick="crawlSingle()">
            å¼€å§‹çˆ¬å–
          </button>
        </div>

        <button class="btn btn-danger" onclick="crawlAll()">
          ğŸ”¥ çˆ¬å–æ‰€æœ‰å¯ç”¨çš„ä¼šè®®
        </button>

        <div id="status" class="status" style="display: none"></div>
      </div>

      <div class="card fade-in" style="margin-top: 24px">
        <h2 class="card-title">ğŸ“‹ å·²é…ç½®çš„ä¼šè®®/æœŸåˆŠ</h2>
        <p style="color: var(--text-secondary); margin-bottom: 24px">
          åœ¨
          <code
            style="
              background: var(--bg-secondary);
              padding: 4px 8px;
              border-radius: 4px;
            "
            >config.yaml</code
          >
          ä¸­å¯ä»¥æ·»åŠ æ›´å¤šä¼šè®®æˆ–æœŸåˆŠ
        </p>
        <div style="display: flex; flex-direction: column; gap: 16px">
          {% for conf in conferences %}
          <div
            class="card"
            style="{% if not conf.enabled %}opacity: 0.5;{% endif %}"
          >
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 24px;
              "
            >
              <div style="flex: 1">
                <h3 style="margin-bottom: 8px">
                  {{ conf.name }} {% if not conf.enabled %}
                  <span
                    class="badge"
                    style="
                      background: var(--bg-secondary);
                      color: var(--text-secondary);
                    "
                    >æœªå¯ç”¨</span
                  >
                  {% endif %}
                </h3>
                <p
                  style="
                    color: var(--text-secondary);
                    margin-bottom: 8px;
                    font-size: 14px;
                  "
                >
                  {{ conf.description or 'æš‚æ— æè¿°' }}
                </p>
                <div style="color: var(--text-secondary); font-size: 13px">
                  å¹´ä»½: {{ conf.years|join(', ') }}
                </div>
              </div>
              {% if conf.enabled %}
              <div style="display: flex; gap: 8px; flex-wrap: wrap">
                {% for year in conf.years %}
                <button
                  class="btn btn-primary"
                  onclick="crawlSingle('{{ conf.name }}', {{ year }})"
                >
                  {{ year }}
                </button>
                {% endfor %}
              </div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="card fade-in" style="margin-top: 24px">
        <h2 class="card-title">ğŸ“ çˆ¬å–æ—¥å¿—</h2>
        <div class="log-display" id="log">ç­‰å¾…å¼€å§‹çˆ¬å–...</div>
      </div>
    </div>

    <script>
      function showStatus(message, type = "info") {
        const status = document.getElementById("status");
        status.textContent = message;
        status.className = "status status-" + type;
        status.style.display = "block";

        if (type === "success" || type === "error") {
          setTimeout(() => {
            status.style.display = "none";
          }, 5000);
        }
      }

      function addLog(message) {
        const log = document.getElementById("log");
        const timestamp = new Date().toLocaleTimeString("zh-CN", {
          hour12: false,
        });
        log.textContent += `[${timestamp}] ${message}\n`;
        log.scrollTop = log.scrollHeight;
      }

      function crawlSingle(confName, confYear) {
        const conference =
          confName || document.getElementById("conference").value;
        const year = confYear || document.getElementById("year").value;

        if (!conference || !year) {
          showStatus("è¯·é€‰æ‹©ä¼šè®®å’Œå¹´ä»½", "error");
          return;
        }

        showStatus(`æ­£åœ¨çˆ¬å– ${conference} ${year}...`, "info");
        addLog(`å¼€å§‹çˆ¬å– ${conference} ${year}`);

        const formData = new FormData();
        formData.append("conference", conference);
        formData.append("year", year);

        fetch("/crawl", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              showStatus(data.message, "success");
              addLog(`âœ“ ${data.message}`);
            } else {
              showStatus(data.message, "error");
              addLog(`âœ— å¤±è´¥: ${data.message}`);
            }
          })
          .catch((error) => {
            showStatus("çˆ¬å–å¤±è´¥: " + error, "error");
            addLog(`âœ— é”™è¯¯: ${error}`);
          });
      }

      function crawlAll() {
        if (!confirm("ç¡®å®šè¦çˆ¬å–æ‰€æœ‰å¯ç”¨çš„ä¼šè®®å—ï¼Ÿè¿™å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ã€‚")) {
          return;
        }

        showStatus("æ­£åœ¨æ‰¹é‡çˆ¬å–...", "info");
        addLog("å¼€å§‹æ‰¹é‡çˆ¬å–æ‰€æœ‰å¯ç”¨çš„ä¼šè®®");

        fetch("/api/crawl_all", {
          method: "POST",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              showStatus(data.message, "success");
              addLog(`âœ“ ${data.message}`);
            } else {
              showStatus(data.message, "error");
              addLog(`âœ— å¤±è´¥: ${data.message}`);
            }
          })
          .catch((error) => {
            showStatus("æ‰¹é‡çˆ¬å–å¤±è´¥: " + error, "error");
            addLog(`âœ— é”™è¯¯: ${error}`);
          });
      }
    </script>
  </body>
</html>
